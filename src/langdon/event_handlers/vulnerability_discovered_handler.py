from __future__ import annotations

from typing import TYPE_CHECKING

from langdon import utils
from langdon.langdon_logging import logger
from langdon.models import Vulnerability

if TYPE_CHECKING:
    from langdon.events import VulnerabilityDiscovered
    from langdon.langdon_manager import LangdonManager


def handle_event(event: VulnerabilityDiscovered, *, manager: LangdonManager) -> None:
    was_already_known = utils.create_if_not_exist(
        Vulnerability,
        defaults={"source": event.source},
        technology_id=event.technology_id,
        manager=manager,
        name=event.name,
    )

    if not was_already_known:
        logger.info("Vulnerability discovered: %s", event.name)
